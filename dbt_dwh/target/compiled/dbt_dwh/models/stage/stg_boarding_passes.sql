-- depends_on: "postgres"."dwh_detailed_dwh_detailed"."raw_boarding_passes"




WITH staging AS (-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    ticket_no,
    flight_id,
    boarding_no,
    seat_no

    FROM "postgres"."dwh_detailed_dwh_detailed"."raw_boarding_passes"
),

derived_columns AS (

    SELECT

    ticket_no,
    flight_id,
    boarding_no,
    seat_no,
    'BOARDING_PASSES'::TEXT AS RECORD_SOURCE,
    CURRENT_TIMESTAMP AS EFFECTIVE_FROM

    FROM source_data
),

hashed_columns AS (

    SELECT

    ticket_no,
    flight_id,
    boarding_no,
    seat_no,
    RECORD_SOURCE,
    EFFECTIVE_FROM,

    DECODE(MD5(NULLIF(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(ticket_no AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(flight_id AS VARCHAR))), ''), '^^')
    ), '^^||^^')), 'hex') AS link_ticket_flight_pk,

    DECODE(MD5(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(boarding_no AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(seat_no AS VARCHAR))), ''), '^^')
    )), 'hex') AS boarding_pass_hashdiff

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ticket_no,
    flight_id,
    boarding_no,
    seat_no,
    RECORD_SOURCE,
    EFFECTIVE_FROM,
    link_ticket_flight_pk,
    boarding_pass_hashdiff

    FROM hashed_columns
)

SELECT * FROM columns_to_select)

SELECT *,
       ('2024-12-15 15:13:34.811294+00:00')::DATE AS LOAD_DATETIME
FROM staging